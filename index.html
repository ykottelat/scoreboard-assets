<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>XML Overlay (WS)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Droid+Sans+Mono&display=swap" rel="stylesheet">
<style>
  :root{ --fg:#fff; }
  html,body{height:100%;margin:0}
  body{
    background:#b71c1c; /* solid red */
    color:var(--fg);
    font-family:'Droid Sans Mono', ui-monospace, Consolas, monospace;
    display:grid; place-items:center;
  }
  .board{
    width:min(100dvw,1024px,calc(100dvh*(16/9)));
    aspect-ratio:16/9; position:relative; overflow:hidden;
    border-radius:24px;
    /* keep the red visible inside the board too */
    background:#b71c1c;
  }
  /* XML layer only */
  .xml-layers{
    position:absolute; inset:0;
    pointer-events:none;
    z-index:12;
  }
  .xml-layers .item{ position:absolute; overflow:hidden; }
  .xml-layers .text{
    display:flex; line-height:1; padding:0 .25rem; word-break:break-word;
  }
  .align-left{justify-content:flex-start;text-align:left}
  .align-center{justify-content:center;text-align:center}
  .align-right{justify-content:flex-end;text-align:right}
  .valign-top{align-items:flex-start}
  .valign-middle{align-items:center}
  .valign-bottom{align-items:flex-end}
</style>
</head>
<body>
  <div class="board">
    <div id="xmlLayers" class="xml-layers" aria-label="XML Layers"></div>
  </div>

<script>
/* ================= setup & tiny logger ================= */
const P = new URLSearchParams(location.search);
const wsLogFilter = (P.get('wslog') || '*').split(',').map(s=>s.trim().toLowerCase());
const shouldLog = t => wsLogFilter[0]==='*' || wsLogFilter.includes((t||'').toLowerCase());
function wsLog(dir, msg){
  const t=(msg?.type||'(no type)').toLowerCase();
  if (!shouldLog(t)) return;
  console.log(`[WS] ${dir} ${t}`, msg);
}

/* ================= XML engine (case-insensitive) ================= */
(function(){
  const LAYERS = document.getElementById('xmlLayers');
  const TARGET_W=1024, TARGET_H=576;
  const DIAG = P.has('diag');

  // Debug helpers
  function tint(el, prefab){
    if (!DIAG) return;
    const c = {panel:'rgba(255,255,255,.03)', image:'rgba(0,0,0,.05)', text:'rgba(255,255,0,.08)'}[prefab] || 'transparent';
    if (!el.style.background) el.style.background = c;
    el.style.outline = '1px dashed rgba(255,255,255,.35)';
  }
  function label(el, name){
    if (!DIAG) return;
    const tag = document.createElement('div');
    tag.textContent = name;
    tag.style.cssText='position:absolute;left:0;top:0;font:10px monospace;background:rgba(0,0,0,.6);color:#fff;padding:2px 4px;border-bottom-right-radius:6px;pointer-events:none;';
    el.appendChild(tag);
  }

  const toPct=(px,dim)=> (px/dim)*100;
  function attrsOf(el){ const o=Object.create(null); for (const a of el.attributes) o[a.name.toLowerCase()]=a.value; return o; }
  function getNum(a,...k){ for (const x of k) if (a[x]!=null && a[x]!=='') return +a[x]; return 0; }
  function getStr(a,...k){ for (const x of k) if (a[x]!=null) return a[x]; return ''; }
  function parseColor(s){
    if (!s) return null;
    if (s.includes(';')){ const [r,g,b,a]=s.split(';').map(n=>+n||0); return `rgba(${r},${g},${b},${(a??255)/255})`; }
    return s;
  }
  function parseFont(s){ if (!s) return {family:`'Droid Sans Mono', monospace`, sizePx:24};
    const [fam,sz] = s.split(';'); return {family:fam||`'Droid Sans Mono', monospace`, sizePx:+(sz||24)}; }
  function alignClasses(val){
    const a=(val||'').toLowerCase();
    const h=a.includes('left')?'align-left':a.includes('right')?'align-right':'align-center';
    const v=a.includes('top')?'valign-top':a.includes('bottom')?'valign-bottom':'valign-middle';
    return `${h} ${v}`;
  }
  function parseNumList(s){ return s? s.split(/[;,]/).map(v=>+v):[]; }
  function buildKeyframes(xs,ys,ts,sx,sy){
    const n=Math.min(xs.length,ys.length,ts.length); if (!n) return {frames:[],duration:0};
    const total=ts[n-1]||.0001, frames=[];
    for (let i=0;i<n;i++){
      frames.push({
        left: toPct(xs[i]*sx, TARGET_W)+'%',
        top:  toPct(ys[i]*sy, TARGET_H)+'%',
        offset: total? (ts[i]/total) : (i===n-1?1:0)
      });
    }
    frames[frames.length-1].offset=1;
    return {frames, duration: total*1000};
  }

  window._xmlByName = Object.create(null);
  let sceneRegistry=null;
  window._xmlBase = null;

  function renderScene(sceneEl){
    if (sceneRegistry?.activeAnims){
      for (const a of sceneRegistry.activeAnims.values()) { try{a.cancel();}catch{} }
    }
    sceneRegistry={tracks:new Map(), activeAnims:new Map()};
    window._xmlByName = Object.create(null);
    LAYERS.innerHTML='';

    // Base size from a Panel (if any)
    let baseW=512, baseH=288;
    const p = [...sceneEl.querySelectorAll('Item, item')].find(n => {
      const a=attrsOf(n); const pf=(a.prefab||a.type||'').toLowerCase(); return pf==='panel';
    });
    if (p){
      const a=attrsOf(p);
      baseW=getNum(a,'width','w','sizex')||512;
      baseH=getNum(a,'height','h','sizey')||288;
    }
    const sx=TARGET_W/baseW, sy=TARGET_H/baseH;

    let built=0;
    for (const it of sceneEl.querySelectorAll('Item, item')){
      const a=attrsOf(it);
      const prefab=(a.prefab||a.type||'unknown').toLowerCase();
      if (prefab==='animationprefab') continue;

      const name = getStr(a,'name') || (a.prefab || 'Item');
      const x=getNum(a,'x'), y=getNum(a,'y'), w=getNum(a,'width','w','sizex'), h=getNum(a,'height','h','sizey');
      const leftPct = toPct(x*sx, TARGET_W), topPct = toPct(y*sy, TARGET_H);
      const wPct = toPct((w||0)*sx, TARGET_W), hPct = toPct((h||0)*sy, TARGET_H);

      let elTag = prefab==='image' ? 'img' : 'div';
      const el = document.createElement(elTag);
      el.className='item';
      el.style.left=leftPct+'%'; el.style.top=topPct+'%';
      el.style.width=wPct+'%';  el.style.height=hPct+'%';
      el.dataset.itemName=name;

      // z-order defaults (Panel < Image < Text)
      let z = prefab==='panel' ? 0 : prefab==='image' ? 1 : 2;
      const zAttr=+(a.z ?? a.order ?? a.layer ?? '');
      if (!Number.isNaN(zAttr)) z = zAttr;
      el.style.zIndex=String(z);

      // Prefab specifics
      if (prefab==='panel'){
        const bg=parseColor(getStr(a,'imagecolor','color','bg'));
        if (bg) el.style.background=bg;
        el.style.pointerEvents='none';
      } else if (prefab==='image'){
        const raw = getStr(a,'defaultimage','image','src');
        const src = raw ? new URL(raw, window._xmlBase || location.href).href : '';
        if (src) el.src = src;
        el.style.objectFit='contain';
        el.style.filter='drop-shadow(0 4px 8px rgba(0,0,0,.35))';
        el.alt=name;
      } else if (prefab==='text'){
        el.classList.add('text');
        const color = parseColor(getStr(a,'textcolor','color')) || 'rgba(255,255,255,.95)';
        const font  = parseFont(getStr(a,'font','fontfamily'));
        const align = getStr(a,'textalignment','alignment','align');
        el.style.color=color;
        el.style.fontFamily=font.family+', monospace';
        el.style.fontWeight=700;
        el.classList.add(...alignClasses(align).split(' '));
        el.textContent = getStr(a,'defaulttext','text','value','content') || '';
        // robust px sizing
        const minPx=(getNum(a,'minfontsize','minfont','minsize')||8)  * (TARGET_H/(baseH||TARGET_H));
        const maxPx=(getNum(a,'maxfontsize','maxfont','maxsize')||200)* (TARGET_H/(baseH||TARGET_H));
        const px=Math.max(minPx, Math.min(Math.round(((h||0)*sy)*0.70), maxPx));
        el.style.fontSize=px+'px';
        el.style.textShadow='0 0 12px rgba(0,0,0,.35)';
      }

      if (DIAG){ tint(el,prefab); label(el,name); }
      LAYERS.appendChild(el);
      window._xmlByName[name]=el;
      built++;

      // Animations
      const animNodes=[...it.querySelectorAll(':scope > Animation, :scope > animation')];
      if (animNodes.length){
        const tr=new Map();
        for (const an of animNodes){
          const aa=attrsOf(an);
          const nm=(getStr(aa,'name')||'Custom').toLowerCase();
          const xs=parseNumList(getStr(aa,'x')), ys=parseNumList(getStr(aa,'y')), ts=parseNumList(getStr(aa,'duration','time','t'));
          const {frames,duration}=buildKeyframes(xs,ys,ts,sx,sy);
          let easing='ease-in-out'; if(/^in$/i.test(nm))easing='cubic-bezier(.2,.8,.2,1)'; if(/^out$/i.test(nm))easing='cubic-bezier(.4,0,.6,1)';
          tr.set(nm,{frames,duration,easing});
        }
        (sceneRegistry.tracks.set(el,tr));
        const init=tr.get('initialposition');
        if (init?.frames?.length){
          const last=init.frames.at(-1);
          if (last.left) el.style.left=last.left;
          if (last.top)  el.style.top =last.top;
        }
      }
    }

    if (DIAG){
      const rect=LAYERS.getBoundingClientRect();
      const kids=[...LAYERS.children];
      const allOff = kids.length>0 && kids.every(ch=>{
        const r=ch.getBoundingClientRect();
        return r.right<rect.left||r.left>rect.right||r.bottom<rect.top||r.top>rect.bottom;
      });
      if (allOff) console.warn('[XML][diag] All items appear off-screen.');
    }

    return built;
  }

  function play(animName){
    if (!sceneRegistry) return;
    const key=(animName||'In').toLowerCase();
    for (const [el,run] of sceneRegistry.activeAnims){ try{run.cancel();}catch{} sceneRegistry.activeAnims.delete(el); }
    for (const [el,tracks] of sceneRegistry.tracks){
      const def=tracks.get(key);
      if (!def || !def.frames.length || def.duration<=0) continue;
      const a=el.animate(def.frames,{duration:def.duration,fill:'forwards',easing:def.easing});
      sceneRegistry.activeAnims.set(el,a);
    }
  }

  function findSceneByName(dom,wanted){
    if (!wanted) return dom.querySelector('Scene, scene');
    wanted=wanted.toLowerCase();
    for (const sc of dom.querySelectorAll('Scene, scene')){
      const a=attrsOf(sc); const v=(a.scenename||a.name||'').toLowerCase();
      if (v===wanted) return sc;
    }
    return null;
  }

  window.playXML = play;
  window.setXMLScene = (name)=>{
    if (!window._xmlDOM) return;
    const next=findSceneByName(window._xmlDOM,name) || findSceneByName(window._xmlDOM,null);
    if (!next) return;
    const count=renderScene(next);
    play('InitialPosition'); setTimeout(()=>play('In'),10);
  };

  window.loadXML = async (url, scene, autoplay)=>{
    console.log('[XML] loading', url);
    let res; try{ res=await fetch(url,{cache:'no-store'});}catch(e){console.error('[XML] fetch fail',e);return;}
    if (!res.ok){ console.error('[XML] HTTP',res.status,res.statusText); return; }
    const xmlText=await res.text();
    const dom=new DOMParser().parseFromString(xmlText,'text/xml');
    if (dom.querySelector('parsererror')){ console.error('[XML] parse error'); return; }
    window._xmlDOM=dom;
    window._xmlBase=new URL(url, location.href);

    const target=findSceneByName(dom, scene) || findSceneByName(dom,null);
    if (!target){ console.warn('[XML] no <Scene>'); return; }
    renderScene(target);
    play('InitialPosition'); setTimeout(()=>play(autoplay||'In'),10);
  };

  // auto-load if provided via query
  const xmlUrl=P.get('xml'); const initialScene=P.get('scene')||null; const autoPlay=P.get('autoplay')||'In';
  if (xmlUrl){ window.loadXML(xmlUrl, initialScene, autoPlay); }
})();

/* ================= WS wiring to your XML item names ================= */
// Server fields: teams {homeName, awayName, homeLogo, awayLogo, sponsor}
//                score {home, away}
//                clock {running, startEpochMs, carryMs}
//                xml   {url, scene, autoplay}
let net=null, skewMs=0;

// update tick: drives GameTime + TOD if present
(function tick(){
  if (window._xmlByName?.GameTime && net){
    const nowMs = Date.now() - (net ? skewMs : 0);
    const elapsed = (net.running ? (nowMs - net.startEpochMs) : 0) + (net.carryMs||0);
    const total = Math.max(0, Math.floor(elapsed/1000));
    const mm = String(Math.floor(total/60)).padStart(2,'0');
    const ss = String(total%60).padStart(2,'0');
    window._xmlByName.GameTime.textContent = `${mm}:${ss}`;
  }
  if (window._xmlByName?.TOD){
    const now = new Date(Date.now() - (net ? skewMs : 0));
    const p=n=>String(n).padStart(2,'0');
    window._xmlByName.TOD.textContent = `${p(now.getHours())}:${p(now.getMinutes())}:${p(now.getSeconds())}`;
  }
  requestAnimationFrame(tick);
})();

// helpers to set images/text safely
function setXmlImage(url, ...names){
  if (!url) return;
  const by = window._xmlByName || {};
  for (const n of names){
    const el = by[n]; if (el && el.tagName==='IMG'){ el.src=url; el.style.visibility='visible'; return; }
  }
}
function setXmlText(val, ...names){
  if (val==null) return;
  const by = window._xmlByName || {};
  for (const n of names){
    const el = by[n]; if (el){ el.textContent=String(val); return; }
  }
}

function applyTeams(t){
  if (!t) return;
  setXmlImage(t.homeLogo, 'ClubLogo');      // left logo
  setXmlImage(t.awayLogo, 'ClubLogo2');     // right logo
  setXmlImage(t.sponsor,  'SponsorLogo');   // sponsor
  setXmlText (t.homeName, 'HomeTeam');
  setXmlText (t.awayName, 'AwayTeam');
}
function applyScore(s){
  if (!s) return;
  if (Number.isFinite(s.home)) setXmlText(s.home, 'HomeScore');
  if (Number.isFinite(s.away)) setXmlText(s.away, 'AwayScore');
}

/* connect WS */
(function(){
  const wsUrl = P.get('ws') ||
    (location.protocol.startsWith('http')
      ? (location.protocol==='https:'?'wss://':'ws://') + location.host + '/ws'
      : '');

  if (!wsUrl){ console.warn('[WS] no URL; pass ?ws=ws://host:port/ws'); return; }

  let ws;
  const connect = ()=>{
    ws = new WebSocket(wsUrl);
    ws.addEventListener('open', ()=>{
      const hello={type:'hello', role:'viewer'}; ws.send(JSON.stringify(hello)); wsLog('→', hello);
    });
    ws.addEventListener('message', (evt)=>{
      let msg; try{ msg=JSON.parse(evt.data); }catch{ return; }
      wsLog('←', msg);
      switch ((msg.type||'').toLowerCase()){
        case 'state':
          if (typeof msg.serverNowMs==='number') skewMs = Date.now()-msg.serverNowMs;
          applyTeams(msg.teams);
          applyScore(msg.score);
          if (msg.clock) net = { running:!!msg.clock.running, startEpochMs:msg.clock.startEpochMs||0, carryMs:msg.clock.carryMs||0 };
          if (msg.xml?.url) window.loadXML?.(msg.xml.url, msg.xml.scene, msg.xml.autoplay);
          if (msg.scene) window.setXMLScene?.(msg.scene);
          break;
        case 'teams': applyTeams(msg); break;
        case 'score': applyScore(msg); break;
        case 'clock':
          net = { running:!!msg.running, startEpochMs:msg.startEpochMs||0, carryMs:msg.carryMs||0 };
          if (typeof msg.serverNowMs==='number') skewMs = Date.now()-msg.serverNowMs;
          break;
        case 'xml':
          if (msg.url) window.loadXML?.(msg.url, msg.scene, msg.autoplay);
          break;
        case 'scene':
          window.setXMLScene?.(msg.name || msg.scene || '');
          if (msg.autoplay) window.playXML?.(msg.autoplay);
          break;
        case 'anim':
          window.playXML?.(msg.name || 'In');
          break;
      }
    });
    ws.addEventListener('close', ()=> setTimeout(connect, 1000));
    ws.addEventListener('error', ()=> { try{ws.close();}catch{} });
  };
  connect();
})();
</script>
</body>
</html>
